<!DOCTYPE html>
<html lang="ny">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notifications</title>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-auth-compat.js"></script>
    <style>
        body { font-family: system-ui; background: #f0f2f5; margin: 0; padding: 15px; }
        .notif-card { background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: flex-start; box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; }
        .unread { border-left: 5px solid red; background: #fff8f8; }
        .content { flex: 1; cursor: pointer; overflow: hidden; }
        
        /* 1 & 3: Kusamalira mipata ndi kudula mizere */
        .msg-text { 
            font-size: 14px; 
            color: #333; 
            margin: 0; 
            white-space: pre-wrap; /* Imasunga ma line breaks */
            word-wrap: break-word;
            display: -webkit-box;
            -webkit-line-clamp: 5; /* Limit to 5 lines */
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
        
        /* Ngati "See More" yadinidwa, onetsa zonse */
        .expanded .msg-text {
            -webkit-line-clamp: unset;
            display: block;
        }

        .see-more {
            color: #007bff;
            font-size: 13px;
            cursor: pointer;
            display: none;
            margin-top: 5px;
            font-weight: bold;
        }

        /* 2: Ma Link aonekere bwino */
        .msg-text a {
            color: #1a73e8;
            text-decoration: underline;
        }

        .time { font-size: 10px; color: gray; margin-top: 5px; display: block; }
        .del-btn { color: #ff4d4d; border: none; background: none; font-size: 18px; cursor: pointer; padding: 5px; margin-left: 10px; }
        header { background: #0a142b; color: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; gap: 15px; }
    </style>
</head>
<body>

<header>
    <span onclick="location.href='dashboard.html'" style="cursor:pointer; font-size:20px;">←</span>
    <b>Notifications Section</b>
</header>

<div id="notifList">Loading......</div>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyDt_ayoflnFkRRnS2fXITY2EzJz0KcW5QA",
    authDomain: "makert-bfb76.firebaseapp.com",
    databaseURL: "https://makert-bfb76-default-rtdb.firebaseio.com",
    projectId: "makert-bfb76",
    storageBucket: "makert-bfb76.firebasestorage.app",
    messagingSenderId: "245693362931",
    appId: "1:245693362931:web:e15662a22dd50d2ac63d86"
};

firebase.initializeApp(firebaseConfig);
const rtdb = firebase.database();
const auth = firebase.auth();

// Function yopanga ma links kukhala clickable
function formatMessage(text) {
    const urlRegex = /(https?:\/\/[^\s]+|www\.[^\s]+)/g;
    return text.replace(urlRegex, (url) => {
        let href = url.startsWith('http') ? url : 'http://' + url;
        return `<a href="${href}" target="_blank" onclick="event.stopPropagation()">${url}</a>`;
    });
}

auth.onAuthStateChanged(user => {
    if(user) {
        rtdb.ref('notifications').orderByChild('to').equalTo(user.uid).on('value', snap => {
            const list = document.getElementById("notifList");
            list.innerHTML = "";
            
            if(!snap.exists()) {
                list.innerHTML = "<p style='text-align:center; color:gray;'>empty.</p>";
                return;
            }

            let notifs = [];
            snap.forEach(child => {
                notifs.push({ id: child.key, ...child.val() });
            });

            notifs.reverse().forEach(n => {
                const isUnread = n.read === false ? "unread" : "";
                const destination = n.link ? n.link : 'dashboard.html';
                const formattedMsg = formatMessage(n.message);

                const card = document.createElement('div');
                card.className = `notif-card ${isUnread}`;
                card.id = `card-${n.id}`;
                
                card.innerHTML = `
                    <div class="content" onclick="markReadAndGo('${n.id}', '${destination}')">
                        <p class="msg-text" id="msg-${n.id}">${formattedMsg}</p>
                        <span id="btn-${n.id}" class="see-more" onclick="toggleExpand(event, '${n.id}')">See more</span>
                        <span class="time">${new Date(n.timestamp).toLocaleString()}</span>
                    </div>
                    <button class="del-btn" onclick="deleteNotif('${n.id}')">×</button>
                `;

                list.appendChild(card);

                // Onani ngati uthenga wadutsa mizere 5 kuti tuonetse "See more"
                const msgElem = document.getElementById(`msg-${n.id}`);
                if (msgElem.scrollHeight > msgElem.clientHeight) {
                    document.getElementById(`btn-${n.id}`).style.display = 'block';
                }
            });
        });
    }
});

// Function yosegula uthenga wonse
function toggleExpand(event, id) {
    event.stopPropagation(); // Kuti isatsegule link ya dashboard
    const card = document.getElementById(`card-${id}`);
    const btn = document.getElementById(`btn-${id}`);
    
    if (card.classList.contains('expanded')) {
        card.classList.remove('expanded');
        btn.innerText = "See more";
    } else {
        card.classList.add('expanded');
        btn.innerText = "See less";
    }
}

function markReadAndGo(id, link) {
    rtdb.ref('notifications/' + id).update({ read: true }).then(() => {
        window.location.href = link;
    });
}

function deleteNotif(id) {
    if(confirm("Do you want to delete this message?")) {
        rtdb.ref('notifications/' + id).remove();
    }
}
</script>
</body>
</html>